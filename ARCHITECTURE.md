# Antigravity Token Visualizer: Architecture Documentation

This document provides a technical overview of the **Antigravity Token Visualizer** VS Code extension.

## High-Level Overview

The extension monitors local conversation logs generated by Antigravity (Google's AI coding assistant), estimates the token count of the conversation context, and visualizes the token usage in real-time within a VS Code Sidebar Webview.

### Data Flow

1.  **Antigravity** writes conversation logs (`.pb` files) to `~/.gemini/antigravity/conversations`.
2.  **`LogMonitor`** (in the extension) watches this directory for changes.
3.  When a file changes, `LogMonitor` reads the latest `.pb` file and extracts "printable text" (heuristic extraction since the proto definition is closed).
4.  **`extension.ts`** passes this text to the **`SidebarProvider`**.
5.  **`SidebarProvider`** uses `js-tiktoken` (cl100k_base) to calculate the token count of the text.
6.  The token count is sent to the **Webview** via the message passing API.
7.  The **Webview** (HTML/JS) updates the Chart.js graph and tokens counters.

---

## Key Components

### 1. Extension Entry Point (`src/extension.ts`)
- **Role**: Bootstraps the extension.
- **Responsibilities**:
    - Registers the `TokenSidebarProvider` for the `antigravity-tokens` view.
    - Registers the `antigravity-token-viz.refresh` command.
    - Initializes the `LogMonitor` and sets up the callback to update the provider when logs change.
    - Handles deactivation (stopping the monitor).

### 2. Log Monitor (`src/LogMonitor.ts`)
- **Role**: File system watcher for Antigravity logs.
- **Dependencies**: `chokidar` (file watching), `fs`, `path`.
- **Key Methods**:
    - `startMonitoring(callback)`: Starts watching `~/.gemini/antigravity/conversations`.
    - `processLatestFile()`: Identifies the most recently modified `.pb` file to resume context.
    - `extractPrintableText(buffer)`: **Crucial Heuristic**. Since the `.pb` files are binary Protocol Buffers and the schema is not available, this method:
        - Filters the raw buffer.
        - Retains printable ASCII (0x20-0x7E), tabs, newlines, and multi-byte sequences (potential UTF-8).
        - Replaces other binary bytes with spaces to avoid breaking UTF-8 decoding.
        - Decodes the result as UTF-8.
        *Note: This is an approximation. It may count "proto wire tags" as tokens, but it provides a relative sense of conversation growth.*

### 3. Sidebar Provider (`src/SidebarProvider.ts`)
- **Role**: Manages the UI and token calculation.
- **Dependencies**: `js-tiktoken` (Token counting), `vscode`.
- **Key Methods**:
    - `updateTokenCount(filePath, text)`:
        - Calculates tokens using `js-tiktoken` (`cl100k_base` encoding).
        - Logic for **Session Accumulation**:
            - If `filePath` changes (new conversation), it resets the "baseline" but possibly not the visual total (depending on implementation).
            - Calculates `delta` (Current Tokens - Last Tokens) to show incremental updates.
            - Posts `token-update-auto` message to the Webview.
    - `_getHtmlForWebview()`: Returns the HTML string.
        - Injects `Chart.js` (currently via CDN).
        - Sets up the frontend logic (`media/main.js` assumed) to listen for messages and update the chart.

---

## Limitations & Known Issues

1.  **Heuristic Parsing**: The text extraction from `.pb` files is not perfect. It treats binary metadata as text or whitespace, which 'cl100k_base' might tokenize. The absolute token count is an **estimate**, but the *trend* (relative increase) is accurate enough for monitoring usage.
2.  **Chart.js CDN**: The extension currently relies on a CDN for Chart.js. Offline usage will fail to load the chart. (TODO: Bundle Chart.js).
